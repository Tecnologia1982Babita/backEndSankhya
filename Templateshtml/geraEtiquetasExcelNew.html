<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">
    <title>Template Geral</title>

    <style>
        table{
    font-size: 1em;
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    margin-top: 3%;
}


thead tr{
    color: #047e29;
}


td, th, table{
    border: 1px solid #047e29;
}

td, th{
    min-width: 20px;
    padding: 1% 0%;
    text-align: center;
}

tr:nth-child(even) {
    background-color: #c9ffd9;
}

tr:nth-child(even):hover {
    background-color: #014114;
}
tr:hover{
    cursor: pointer;
}
tbody tr:hover{
    background-color: #014114;
    color: #FFFFFF;
}


button:is(:hover,:focus,:active){
cursor: pointer;
background: #047e29;
color: #fff;
}

button {
    appearance: none;
    border: 0.2em solid #047e29;
    background: hsl(0 0 0/0);
    padding: 0.85em 1.5em;
    color: #047e29;
    border-radius: 2em;
    transition: 0.5s;
    margin: 1% 1%;
    flex: 0 0 8%;
}

.flexDiv{
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-start;
}

input[type="text"], input[type="number"] {
    appearance: none;
    border: none;
    outline: none;
    border-bottom: .2em solid #047e29;
    background: rgba(#047e29, .2);
    border-radius: .2em .2em 0 0;
    color: #047e29;
    width: 100px;
    flex: 0 0 10%;
    height: fit-content;
    margin: 1% 2%;
    width: fit-content;
}


input[type="checkbox"]{
    -webkit-appearance: none;
    appearance: none;
    background-color: #fff;
    margin: 0;
    margin-right: 5px;
    font: inherit;
    color: #fff;
    width: 1.15em;
    height: 1.15em;
    border: 0.15em solid #047e29;
    border-radius: 0.15em;
    transform: translateY(-0.075em);
    display: grid;
    place-content: center;
}

input[type="checkbox"]::before {
    content: "";
    width: 0.65em;
    height: 0.65em;
    transform: scale(0);
    transition: 120ms transform ease-in-out;
    box-shadow: inset 1em 1em #047e29;
    background-color: CanvasText;
}

input[type="checkbox"]:checked::before {
    transform: scale(1);
    box-shadow: inset 1em 1em #047e29;
}

input[type="checkbox"]:focus {
    outline: max(2px, 0.15em) solid currentColor;
    outline-offset: max(2px, 0.15em);
}

.estiloCheckBox{
    flex: 0 0 6%;
    display: flex;
    min-width: fit-content;
}


input[type="file"] {
    display: none;
}
label {
    border: 0.2em solid #047e29;
    background: hsla(0, 0%, 19%, 0);
    padding: 0.85em 1.5em;
    color: #047e29;
    border-radius: 2em;
    transition: 0.5s;
    margin: 1% 1%;
    flex: 0 0 8%;
    text-transform: uppercase;
    text-align: center;
    display: block;
    cursor: pointer;
}
label:is(:hover,:focus,:active){
cursor: pointer;
background: #047e29;
color: #fff;
}

    </style>
</head>

<body>
  <div id="telaFiltro">
    <div id="btnLine" class="flexDiv">
        <label for="input-excel">Enviar excel</label>
        <input type="file" id="input-excel" title="Inserir Excel"/>
        <button id="geraExcel" onclick="if (atualizandoTabela != 1) { alert('Aguarde a consulta dos códigos.'); } else { htmlGeradoEtiqueta(); }">Gerar Etiquetas</button>
    </div>
    </div>

    <table id="etiqueta">
    </table>
</div>

<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="
https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js
"></script>
<script>

let dadosTabela = []


let etiquetas = []
let atualizandoTabela = 0
document.getElementById('input-excel').addEventListener('change', function(e) {
  var reader = new FileReader();
  reader.onload = function(e) {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, {type: 'array'});
      
      var worksheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

      InsereTabela(jsonData)
      // Agora você tem os dados do Excel em formato JSON e pode inseri-los em sua tabela HTML.
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});


function InsereTabela(resp){
  //resp.shift()
  atualizandoTabela = 0
  dadosTabela = resp
  
  //Adiciona colunas a tabela da página
  let tabela = document.getElementById('etiqueta')
                      tabela.innerHTML = `<thead>
                              <tr>
                                  <th>COD FORN</th>
                                  <th>FORNECEDOR</th> 
                                  <th>REVISTA</th>
                                  <th>ITEM</th>
                                  <th>DESC PROD</th>
                                  <th>D. BASICA</th>
                                  <th>TAM</th>
                                  <th>PRECO</th>
                                  <th>PAG</th>
                                  <th>QUANTIDADE</th>
                          </tr>
                          </thead>
                          <tbody>
                          </tbody>`;

                      //seleciona a tabela novamente, porém dentro de ond os dados vão ficar
                      tabela = document.querySelector('#etiqueta tbody')
                      let insereCelulas = 0

                      //é feito um loop em cima dos dados buscados a partir do excel
                      let promises = resp.map(async (objeto,i) => {
                          
                          //é descartada a primeira e ultima linha do excel
                          if(objeto[0] == "FINAL" || objeto.length <= 1){
                            insereCelulas = 1
                          }
                          if (i != 0 && insereCelulas === 0){
                              let linha = await tabela.insertRow();

                                
                                let chaveValorObj = {}
                                //é utilizada as colunas do arquivo para preparar o objeto de cada produto, no array de items
                                Object.values(objeto).forEach((val,index)=>{
                                  chaveValorObj[resp[0][index]] = val
                                })

                                //adiciona os valores a um array de objetos
                                etiquetas.push({...chaveValorObj})

                                //é adicionado os valores a tabela na pagina
                                await Object.keys(objeto).forEach((val)=>{
                                  if (val != "0"){
                                    let celula = linha.insertCell();
                                    let texto = '';
                                    if (objeto[val] == null || objeto[val] == 'null'){
                                      texto = document.createTextNode("-") 
                                    }else{
                                      texto = document.createTextNode(objeto[val])
                                    }
                                    
                                    celula.appendChild(texto);
                                  }
                                    
                                    
                                  })
                                  
                          }
                      });   
                          //habilitando a geração das etiquetas
                          alert('Tabela Atualizada! Pode gerar as etiquetas!')
                          atualizandoTabela = 1

                      

                  }

//Apenas uma função construtora, que retorna um html contendo uma etiqueta
// é passada todas as informações a serem adicionadas incluindo o código de barras
// é configurada também o css de cada etiqueta, sensível ao tamanho da folha
const templateEtiqueta = (params, classe="")=>{
  return `<div class="mainbar ${classe}" style="flex: 0 0 26%;
  margin: 1.15% 1% 1.15% 1%;
  height: fit-content;
  align-self: flex-start;
  ">
  <div class="barcode-container">
  <img class='barcode' data-barcode='${params.codigoBarras}'>
  </div>
  <div class="descPrinc">
  <div>${params.item}</div>
  <div>${params.tamanho}</div>
  </div>

  <div class="descPrinc">
  <div>${params.fornecedor}</div>
  <div>${params.descricao}</div>
  </div>

  <div class="descPrinc">
  <div>${params.revista}</div> 
  <div>${params.pagina}</div>
  </div>
</div>`
}

   //Insere uma barra ao codigo Ex.: 12345 -> 1234/5
  function insereBarra(valor){
    let txtTMP = `${valor}`
    txtTMP = txtTMP.slice(0, -1) + "/" + txtTMP.slice(-1) 
    return txtTMP
  }


  /*Preenche o array com os templates já com os valores de etiqueta, em resumo retorna
  o html das etiquetas, sua principal função é desempenhada, quando há uma folha com
  menos de 30 etiquetas, ele cria "etiquetas", fantasmas, para que as etiquetas 
  fiquem no espaçamento e ordens ideal
  */
  function preencherArrayPorColunas(quantidadeRestante,etiquetasParam) {
    const numLinhas = 10; // Número fixo de linhas
    const numColunas = 3; // Número fixo de colunas

    //ELEMENTO PADRAO, PARA NAO BUGAR ALINHAMENTO E INSERIDO ALGUNS ELEMENTOS INVISIVEIS
    const arrayPorColunas = new Array(30).fill(templateEtiqueta({
            codigoBarras : "016891503221257910022112",
            item : "3325/1 CONJUNTO-3",
            tamanho: "G",
            fornecedor : "14456/8 IS SIX",
            descricao: "CONJUNTO",
            revista: "C8Y123/7 PRIMAVERA I",
            pagina: "PAG : 00"
          },'fantasma'));
          
        
    let colunaAtual = 0;
    let indiceElementoAPreencher = 0 
    for (let i = 0; quantidadeRestante > 0; i++) {
      for (let j = 0; j < numLinhas; j++) {
        const index = j * numColunas + colunaAtual;
        if (quantidadeRestante > 0) {
          if (etiquetasParam[indiceElementoAPreencher].quantidade == 0){
            arrayPorColunas[index] = templateEtiqueta({
              codigoBarras : "016891503221257910022112",
              item : "3325/1 CONJUNTO-3",
              tamanho: "G",
              fornecedor : "14456/8 IS SIX",
              descricao: "CONJUNTO",
              revista: "C8Y123/7 PRIMAVERA I",
              pagina: "PAG : 00"
    
            },'fantasma')
          }else{
            
            let precoTMP =  parseFloat(etiquetasParam[indiceElementoAPreencher].PRECO).toString()
            let descbasica_nome = etiquetasParam[indiceElementoAPreencher]["DESC BASICA"]
            descbasica_nome = descbasica_nome.indexOf(' ') > -1 & descbasica_nome.length > 10 ? descbasica_nome.split(' ').map((val)=>val.substr(0,4)+'.').join(' ').substr(0,10) : descbasica_nome.substr(0,10)
            arrayPorColunas[index] = templateEtiqueta({ //ELEMENTO A PREENCHER ATUAL
              codigoBarras : etiquetasParam[indiceElementoAPreencher]["ETIQUETA"],
              item : `${insereBarra(etiquetasParam[indiceElementoAPreencher].ITEM)} ${etiquetasParam[indiceElementoAPreencher]["DESC PROD"]}`,
            tamanho : etiquetasParam[indiceElementoAPreencher].TAM,
            fornecedor : `${insereBarra(etiquetasParam[indiceElementoAPreencher]["COD FORN"])} ${
              etiquetasParam[indiceElementoAPreencher]["FORNECEDOR"].substr(0,10)}`,

            descricao : descbasica_nome,
           revista : `${  `${etiquetasParam[indiceElementoAPreencher]["COD FORN"]}`.substr(0,2)  }`+
            `Y${precoTMP.substr(0,precoTMP.length-2).replaceAll(".","")}/${precoTMP.substr(precoTMP.length-1,1)}`+
            ` ${etiquetasParam[indiceElementoAPreencher]["REVISTA"] ? 
              etiquetasParam[indiceElementoAPreencher]["REVISTA"].substr(0,13) 
              :  etiquetasParam[indiceElementoAPreencher]["FORNECEDOR"]}`,
            pagina : etiquetasParam[indiceElementoAPreencher]["PAG"] != '-' ? `PAG : ${etiquetasParam[indiceElementoAPreencher]["PAG"]}` : ''
            });
          }
          indiceElementoAPreencher++
          quantidadeRestante--;
        }
      }
      colunaAtual = (colunaAtual + 1) % numColunas;
    }
    
    //console.log(arrayPorColunas)
    return arrayPorColunas;
  }

/*
Divide todas as etiquetas em grupos de 30
e ao fim retorna as etiquetas com o padrão de preenchimento, por coluna
de cima a baixo, Ex.: col1 [1,2,3..10] | col2 [11,12,13..20] | col3 [21,22,23..30]
*/
  function divideColunas(arrayOrig){
    temporary = []
    for (let x = 0; x < (arrayOrig.length / 30); x++) {
        if (x == 0) {
            temporary[x] = arrayOrig.slice(0, 30)
        } else {
            temporary[x] = arrayOrig.slice(x * 30, (x * 30) + 30)
        }
    
    }
    arrayOrig = []
    temporary.forEach(val =>{
        arrayOrig.push(retornaColunas(val))
    })
    arrayOrig = [].concat(...arrayOrig)
    return arrayOrig
}


/*
Pega os grupos de 30 individualmente e organiza no padrão de preenchimento
*/
function retornaColunas(arrayOrig){
    temporary = []
    for (let x = 0; x < (arrayOrig.length / 10); x++) {
        if (x == 0) {
            temporary[x] = arrayOrig.slice(0, 10)
        } else {
            temporary[x] = arrayOrig.slice(x * 10, (x * 10) + 10)
        }
    
    }
    arrayOrig = []
    
    let maxLength = Math.max(...temporary.map(arr => arr.length));
    
    for(let i = 0; i < maxLength; i++) {
        for(let arr of temporary) {
            if(i < arr.length) {
                arrayOrig.push(arr[i]);
            }
        }
    }
    return arrayOrig
}

// CRIAR FUNÇÃO PARA CRIAR CÓDIGO PRIMEIRO
function htmlGeradoEtiqueta (){


  /*etiquetas [ {
    codigoBarras
    item
    tamanho
    fornecedor
    descricao
    revista
    pagina
  }]
  */
  /*let posicao = parseInt(document.getElementById('posicaoInput').value)
  posicao = posicao ? posicao : 0
  posicao = posicao > 0 ? posicao - 1 : 0 // tirando 1 da posição, pois ela incia em 0*/
  let quantidadeEtiquetas = 0
  let todasEtiquetas =  []

  
//  for (let x = 0; x<posicao; x++){
//      todasEtiquetas.push({"quantidade": 0})
//  }
 
  etiquetas.forEach((val)=>{
    if (val.QUANTIDADE != 0){
      quantidadeEtiquetas += val.QUANTIDADE
      for (let y =0; y < val.QUANTIDADE; y++){
        todasEtiquetas.push(val)
      }
    }
  })
  //console.log(todasEtiquetas)
  todasEtiquetas = divideColunas(todasEtiquetas)

  //console.log(todasEtiquetas)
  let pagina = 0
  let etiquetasList = ''
  let mainContent = {}
  //Faz um Loop com as paginas em que as etiquetas preenchem totalmente 3x10
  let loopQuantidade = Math.floor(quantidadeEtiquetas/30).toFixed(0)*30  
  
  for (let loop = 0; loop < loopQuantidade; loop++){
    if(loop == 0){ 
      pagina += 1;
      etiquetasList += `<div id="mainContent${pagina}" class="mainContent">`
      mainContent[`mainContent${pagina}`] = ''
    }
    if (todasEtiquetas[loop].quantidade === 0){
      
      mainContent[`mainContent${pagina}`] += templateEtiqueta({
        codigoBarras : "016891503221257910022112",
        item : "3325/1 CONJUNTO-3",
        tamanho: "G",
        fornecedor : "14456/8 TESTE",
        descricao: "CONJUNTO",
        revista: "C8Y123/7 FANTASMA I",
        pagina: "PAG : 00"

      },'fantasma')

    }else{
      let descbasica_nome = todasEtiquetas[loop]["DESC BASICA"]
      descbasica_nome = descbasica_nome.indexOf(' ') > -1 & descbasica_nome.length > 10 ? descbasica_nome.split(' ').map((val)=>val.substr(0,4)+'.').join(' ').substr(0,10) : descbasica_nome.substr(0,10)
            

      let precoTMP =  parseFloat(todasEtiquetas[loop].PRECO).toString()
      mainContent[`mainContent${pagina}`] += templateEtiqueta({ //cria um template em html de uma etiquetas
            codigoBarras : todasEtiquetas[loop]["ETIQUETA"],
            item : `${insereBarra(todasEtiquetas[loop].ITEM)} ${todasEtiquetas[loop]["DESC PROD"]}`,
            tamanho : todasEtiquetas[loop].TAM,
            fornecedor : `${insereBarra(todasEtiquetas[loop]["COD FORN"])} ${
              todasEtiquetas[loop]["FORNECEDOR"].substr(0,10)}`,
            descricao : descbasica_nome,
           revista : `${`${todasEtiquetas[loop]["COD FORN"]}`.substr(0,2)}`+
            `Y${precoTMP.substr(0,precoTMP.length-2).replaceAll(".","")}/${precoTMP.substr(precoTMP.length-1,1)}`+
            ` ${todasEtiquetas[loop]["REVISTA"] ? todasEtiquetas[loop]["REVISTA"].substr(0,13) : todasEtiquetas[loop]["FORNECEDOR"]}`,
            
            pagina : todasEtiquetas[loop]["PAG"] != '-' ? `PAG : ${todasEtiquetas[loop]["PAG"]}` : ''
        })
    }
      
      if((loop+1)%30 == 0 && loop !== 0){ //Adiciona uma nova divisão de pagina a cada 30 (o for comeca do 0 por isso %30)
        pagina += 1;        
        etiquetasList += `${mainContent[`mainContent${pagina-1}`]}</div><div id="mainContent${pagina}" class="mainContent">`
        mainContent[`mainContent${pagina}`] = ''
      }

  }

  //Pega a quantidade restante de etiquetas, aquelas que n preenchem uma página inteira
  let quantidadeRestante =  quantidadeEtiquetas - loopQuantidade
  if(quantidadeRestante > 0){
    const etiquetasrestantes = loopQuantidade === 0 ? todasEtiquetas : todasEtiquetas.slice(loopQuantidade);
    const arrayPreenchido = preencherArrayPorColunas(quantidadeRestante, etiquetasrestantes,todasEtiquetas);
    pagina += 1;
    
    mainContent[`mainContent${pagina}`] = ''
    mainContent[`mainContent${pagina}`] += loopQuantidade === 0 ? `<div id="mainContent${pagina}" class="mainContent">` : ''

    for (let loop = 0; loop < arrayPreenchido.length; loop++){
      mainContent[`mainContent${pagina}`] += arrayPreenchido[loop]
    }

  }
  mainContent[`mainContent${pagina}`] += '</div>'
  etiquetasList += mainContent[`mainContent${pagina}`]


  //Muda todo o estilo da pagina para adaptar as etiquetas
  var style = document.getElementsByTagName('style')[0].innerHTML = `
 @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap');


 html, body {
        display: flex;
        flex-direction: column;
        min-height: 100%;
        margin: 0;
        padding: 0;
      }
    
      header, footer {
        display: none;
      }
    
      #etiquetas{
        height: 100%;
      }
      .mainContent{
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        justify-content: space-around;
        width: 100%;
        height: fit-content;
        padding-top: 2%; 
        page-break-after: always;
      }

.fantasma{
  visibility: hidden;
}

.mainContent .mainBar:nth-child(3n+2){
  margin: 2.0% 8%;
}

/*.barcode{
  width: 100%;
  aspect-ratio: 167/25;
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  }*/

  .barcode-container{
    position: relative;
    width: 100%;
    height: 0;
    padding-top: calc(25/167 * 100%);
  }
  .barcode {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.descPrinc{
  display: flex;
  justify-content: space-between;
  font-family: 'Roboto', sans-serif;
  font-size: 10px;
}
.txtBAR{
  margin-bottom: 0;
  margin-top: 0.8%;
}
/*

Largura  21.59cm 816px 100%
paddingHorizontal 0.48cm 18.141px 2.22%
Altura 27.94cm 1056px 100%
marginTop 1.27cm 48px 4.545%

largura cod 6.67cm 252.1px 30.89%
altura cod 2.54cm 96px 9.09%

*/`

  
  //insere as etiquetas
      document.getElementsByTagName('body')[0].innerHTML = `
    <div id="etiquetas">
      ${etiquetasList}
    </div>`



    //pega o código de barras de cada elemento e gera a imagem do código de barras
    let codigoGeral = $(".mainbar .barcode")
    let codigoGeralTAM = codigoGeral.length -1
    codigoGeral.each(function (index) {
            const barcodeValue = $(this).attr("data-barcode");
            //console.log(barcodeValue)
            var canvasElement = document.createElement('img');
            JsBarcode(canvasElement, barcodeValue, {
                displayValue: false,
                height: 80,
                fontSize: 12,
                margin: 0,
            });

            $(this).attr('src', canvasElement.src);
            //9 px
            $(this).parent().after(`<p class="txtBAR" style="font-size: 9px; text-align: center; ">
              ${barcodeValue.substring(0, 19)}${`${Math.round(Math.random() * 100)}`.padStart(2, '0')}990</p>`);

          })

          //manda imprimir após a página estar completa e recarregada
          setTimeout(()=>print(), 500) 
}






    </script>
</body>
</html>